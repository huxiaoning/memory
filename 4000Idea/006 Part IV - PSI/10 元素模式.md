# 元素模式

&emsp;&emsp;元素模式提供了一种通用的方式来指定对象的条件。

&emsp;&emsp;插件作者使用它们来检查PSI元素是否与一个特定的结构相匹配。就像字符串的正则表达式测试一个（子）字符串是否与一个特定的模式相匹配一样，元素模式被用来对PSI元素的嵌套结构设置条件。它们在IntelliJ平台中的两个主要应用是：

- 为自定义语言实现[自动完成贡献者](https://plugins.jetbrains.com/docs/intellij/completion-contributor.html)时指定自动完成应发生的位置。
- 指定PSI元素，通过PSI参考贡献者提供进一步参考。

&emsp;&emsp;然而，插件作者很少直接实现[ElementPattern](https://github.com/JetBrains/intellij-community/blob/idea/231.8109.175/platform/core-api/src/com/intellij/patterns/ElementPattern.java)接口。相反，我们建议使用IntelliJ平台提供的高级模式类：

| 类                                                           | 主要内容                                                     | 值得注意的示例                                               |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| [`StandardPatterns`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/platform/core-api/src/com/intellij/patterns/StandardPatterns.java) | 字符串和char模式的工厂（见下文）；逻辑操作，如and, or, not   | [`LogbackReferenceContributor`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/plugins/groovy/src/org/jetbrains/plugins/groovy/ext/logback/LogbackReferenceContributor.kt), [`RegExpCompletionContributor`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/RegExpSupport/src/org/intellij/lang/regexp/RegExpCompletionContributor.java) |
| [`PlatformPatterns`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/platform/core-api/src/com/intellij/patterns/PlatformPatterns.java) | PSI、IElement和VirtualFile模式的工厂                         | [`FxmlReferencesContributor`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/plugins/javaFX/src/org/jetbrains/plugins/javaFX/fxml/refs/FxmlReferencesContributor.java), [`PyDataclassCompletionContributor`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/python/python-psi-impl/src/com/jetbrains/python/codeInsight/completion/PyDataclassCompletionContributor.kt) |
| [`PsiElementPattern`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/platform/core-api/src/com/intellij/patterns/PsiElementPattern.java) | PSI的模式；对于子节点、父节点或相邻叶子的检查。              | [`XmlCompletionContributor`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/xml/impl/src/com/intellij/codeInsight/completion/XmlCompletionContributor.java) |
| [`CollectionPattern`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/platform/core-api/src/com/intellij/patterns/CollectionPattern.java) | 过滤和检查模式集合；主要用于为其他高级模式类提供功能。       | [`PsiElementPattern`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/platform/core-api/src/com/intellij/patterns/PsiElementPattern.java) |
| [`TreeElementPattern`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/platform/core-api/src/com/intellij/patterns/TreeElementPattern.java) | 用于检查(PSI)树结构的模式                                    | [`PyMetaClassCompletionContributor`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/python/python-psi-impl/src/com/jetbrains/python/codeInsight/completion/PyMetaClassCompletionContributor.java) |
| [`StringPattern`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/platform/core-api/src/com/intellij/patterns/StringPattern.java) | 检查字符串是否匹配，长度是否符合特定要求，是否以特定的开头或结尾，或者是否属于字符串集合中的一个。 | [`AbstractGradleCompletionContributor`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/plugins/gradle/java/src/codeInsight/AbstractGradleCompletionContributor.kt) |
| [`CharPattern`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/platform/core-api/src/com/intellij/patterns/CharPattern.java) | 检查字符是否为空格、数字或Java标识符的部分。                 | [`CompletionUtil`](https://github.com/JetBrains/intellij-community/tree/idea/231.8109.175/platform/analysis-impl/src/com/intellij/codeInsight/completion/CompletionUtil.java) |

&emsp;&emsp;IntelliJ平台中的一些内置语言实现了他们自己的模式类，可以提供额外的例子：

- [`XmlPatterns`](https://github.com/JetBrains/intellij-community/blob/idea/231.8109.175/xml/xml-psi-api/src/com/intellij/patterns/XmlPatterns.java) 提供了用于 XML 属性、值、实体和文本的模式。
- [`PythonPatterns`](https://github.com/JetBrains/intellij-community/blob/idea/231.8109.175/python/src/com/jetbrains/python/patterns/PythonPatterns.java)为Python提供了字面量、字符串、参数以及函数/方法参数的模式。
- [`DomPatterns`](https://github.com/JetBrains/intellij-community/blob/idea/231.8109.175/xml/dom-openapi/src/com/intellij/patterns/DomPatterns.java) 基于 `XmlPatterns` 并作为一个包装器，为 [DOM-API](https://plugins.jetbrains.com/docs/intellij/xml-dom-api.html) 提供更多的模式。

### 示例

&emsp;&emsp;元素模式的一个良好起点是[《自定义语言支持教程》](https://plugins.jetbrains.com/docs/intellij/custom-language-support-tutorial.html)。它们被用于该教程的[完成](https://plugins.jetbrains.com/docs/intellij/completion-contributor.html#define-a-completion-contributor)和[参考](https://plugins.jetbrains.com/docs/intellij/reference-contributor.html#define-a-reference-contributor)贡献者部分。然而，IntelliJ平台的源代码为内置语言（如JSON、XML、Groovy、Markdown等）提供了更多元素模式的例子。检查上表中的参考文献或搜索高级模式类的使用情况将提供一个全面的列表，显示元素模式在生产代码中的使用情况。

&emsp;&emsp;例如，我们可以在JavaFX插件[`FxmlReferencesContributor`](https://github.com/JetBrains/intellij-community/blob/idea/231.8109.175/plugins/javaFX/src/org/jetbrains/plugins/javaFX/fxml/refs/FxmlReferencesContributor.java)中找到一个例子，该插件测试给定的PSI元素是否是*.fxml文件中的XML属性值。

```java
XmlAttributeValuePattern attributeValueInFxml =
  XmlPatterns.xmlAttributeValue().inVirtualFile(
    virtualFile().withExtension(JavaFxFileTypeFactory.FXML_EXTENSION));
```

&emsp;&emsp;如上面的代码所示，元素模式可以被堆叠和组合以创建更复杂的条件。[`JsonCompletionContributor`](https://github.com/JetBrains/intellij-community/blob/idea/231.8109.175/json/src/com/intellij/json/codeinsight/JsonCompletionContributor.java)包含另一个例子，对PSI元素有更多要求。

```java
PsiElementPattern.Capture<PsiElement> AFTER_COMMA_OR_BRACKET_IN_ARRAY =
  psiElement().
  afterLeaf("[", ",").
  withSuperParent(2, JsonArray.class).
  andNot(
    psiElement().
    withParent(JsonStringLiteral.class)
  );
```

&emsp;&emsp;以上的模式确保了PSI元素：

1. 出现在开放括号或逗号之后，通过对相邻的叶子元素施加限制来表达。
2. 有`JsonArray`作为二级父级，这表明PSI元素必须在一个JSON数组内。
3. 没有`JsonStringLiteral`作为父体，这就避免了在数组内带有括号或逗号的字符串会产生错误的匹配的情况。

&emsp;&emsp;最后一个例子表明即使是简单的模式，也需要仔细考虑边角情况。

### 工具和调试
