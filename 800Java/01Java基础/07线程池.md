# 线程池



### 为什么要使用线程池

##### 线程是不是越多越好？

1. 线程在java中是一个对象，更是操作系统的资源，线程创建、销毁需要时间。如果创建时间＋销毁时间＞执行任务时间就很不合算。
2. java对象占用堆内存，操作系统线程占用系统内存，根据jvm规范，一个线程默认最大栈大小1M，这个栈空间是需要从系统内存中分配的。线程过多，会消耗很多的内存。
3. 操作系统需要频繁切换线程上下文（大家都想被运行），影响性能。



线程池的推出，就是为了方便的控制线程数量。



### 线程池原理 - 概念

1. **线程池管理器**：用于创建并管理线程池，包括创建线程池，销毁线程池，添加新任务；
2. **工作线程**：线程池中线程，在没有任务时处于等待状态，可以循环的执行任务；
3. **任务接口**：每个任务必须实现的接口，以供工作线程调度任务的执行，它主要规定了任务的入口，任务执行完后的收尾工作，任务的执行状态等；
4. **任务队列**：用于存放没有处理的任务。提供一种缓冲机制。



### 线程池API - 接口定义和实现类

| 类型   | 名称                        | 描述                                                         |
| ------ | --------------------------- | ------------------------------------------------------------ |
| 接口   | Executor                    | 最上层的接口，定义了执行任务的方法execute                    |
| 接口   | ExecutorService             | 继承了Executor接口，拓展了Callable、Future、关闭方法         |
| 接口   | ScheduledExecutorService    | 继承了ExecutorService，增加了定时任务相关的方法              |
| 实现类 | ThreadPoolExecutor          | 基础、标准的线程池实现                                       |
| 实现类 | ScheduledThreadPoolExecutor | 继承了ThreadPoolExecutor，实现了ScheduledExecutorService中相关定时任务的方法 |



### Executor API

```java
void execute(Runnable command);
```



### ExecutorService API

```java
// 监测ExecutorService是否已经关闭，直到所有任务完成执行，或超时发生，或当前线程被中断
awaitTermination(long timeout,TimeUnit unit)
// 执行给定的任务集合，执行完毕后，返回结果
invokeAll(Collection<? extends Callable<T>>tasks)
// 执行给定的任务集合，执行完毕或者超时后，返回结果，其他任务终止
invokeAll(Collection<? extends Callable<T>>tasks, long timeout,TimeUnit unit) 
// 执行给定的任务，任意一个执行成功则返回结果，其他任务终止
invokeAny(Collection<? extends Callable<T>>tasks)
// 执行给定的任务，任意一个执行成功或者超时后，则返回结果，其他任务终止
invokeAny(Collection<? extends Callable<T>> tasks, long timeout,TimeUnit unit) 
// 如果此线程池已关闭，则返回true。
isShutdown()
// 如果关闭后所有任务都已完成，则返回true。
isTerminated()
// 优雅关闭线程池，之前提交的任务将被执行，但是不会接受新的任务。
shutdown()
// 尝试停止所有正在执行的任务，停止等待任务的处理，并返回等待执行任务的列表。
shutdownNow()
// 提交一个用于执行的Callable返回任务，并返回一个Future，用于获取Callable执行结果
submit(Callable<T>task)
// 提交可运行任务以执行，并发回一个Future对象，执行结果为null
submit(Runnable task)
// 提交可运行任务以执行，并返回Future，执行结果为传入的result
submit(Runnable task,T result)
```



### ScheduledExecutorService API

```java
// 创建并执行一个一次性任务,过了延迟时间就会被执行
schedule(Callable<V> callable, long delay, TimeUnit unit)
schedule(Runnable command, long delay, TimeUnit unit)
// 创建一些周期性执行的任务,过了给定的初始延迟时间，会第一次被执行，执行过程中发生了异常，那么任务就停止。
scheduleAtFixedRate(Runnable command,long initialDelay,long period,TimeUnit unit)
scheduleWithFixedDelay(Runnable command,long initialDelay,long delay,TimeUnit unit)
```

